{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title }} - {{ course.title }}{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .video-player {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .video-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 1rem;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }
    
    .video-container:hover .video-controls {
        transform: translateY(0);
    }
    
    .control-button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1rem;
        padding: 0.5rem;
        margin: 0 0.25rem;
    }
    
    .control-button:hover {
        color: #3b82f6;
    }
    
    .progress-container {
        width: 100%;
        height: 0.5rem;
        background: rgba(255, 255, 255, 0.3);
        cursor: pointer;
        margin: 0.5rem 0;
    }
    
    .progress-bar {
        height: 100%;
        background: #3b82f6;
        width: 0%;
    }
    
    .notes-container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .note-item {
        border-bottom: 1px solid #e5e7eb;
        padding: 0.75rem 0;
    }
    
    .note-timestamp {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-3">
                <!-- Video Player -->
                <div class="video-container aspect-video mb-6">
                    {% if lesson.video_url %}
                        <video id="videoPlayer" class="video-player">
                            <source src="{{ lesson.video_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        
                        <!-- Custom Video Controls -->
                        <div class="video-controls">
                            <div class="progress-container" id="progressContainer">
                                <div class="progress-bar" id="progressBar"></div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <button class="control-button" id="playPauseBtn">
                                        <i class="fas fa-play" id="playIcon"></i>
                                    </button>
                                    <button class="control-button" id="pipBtn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                    <button class="control-button" id="volumeBtn">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" class="w-20">
                                    
                                    <select id="playbackRate" class="bg-gray-700 text-white rounded px-2 py-1 text-sm ml-2">
                                        <option value="0.5">0.5x</option>
                                        <option value="0.75">0.75x</option>
                                        <option value="1" selected>1x</option>
                                        <option value="1.25">1.25x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="2">2x</option>
                                    </select>
                                    
                                    <span id="currentTime" class="text-sm mx-2">0:00</span>
                                    <span>/</span>
                                    <span id="duration" class="text-sm mx-2">0:00</span>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <button class="control-button" id="notesBtn">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                    <button class="control-button" id="captionsBtn">
                                        <i class="fas fa-closed-captioning"></i>
                                    </button>
                                    <button class="control-button" id="fullscreenBtn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-white text-center p-8">
                            <div>
                                <i class="fas fa-video text-6xl mb-4"></i>
                                <p class="text-xl mb-2">Video content coming soon</p>
                                <p class="text-gray-300">Please check back later for this lesson</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Lesson Info and Notes -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ lesson.title }}</h1>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">{{ lesson.description }}</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="addNoteBtn" class="btn-outline text-sm">
                                <i class="fas fa-plus mr-1"></i> Add Note
                            </button>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div id="notesSection" class="hidden mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">My Notes</h3>
                        
                        <!-- Add Note Form -->
                        <div class="mb-4">
                            <textarea id="noteText" placeholder="Add your note here..." class="input w-full mb-2" rows="3"></textarea>
                            <div class="flex justify-between">
                                <button id="saveNoteBtn" class="btn-primary text-sm">
                                    <i class="fas fa-save mr-1"></i> Save Note
                                </button>
                                <button id="addTimestampBtn" class="btn-outline text-sm">
                                    <i class="fas fa-clock mr-1"></i> Add Timestamp
                                </button>
                            </div>
                        </div>
                        
                        <!-- Notes List -->
                        <div id="notesList" class="notes-container">
                            <!-- Notes will be populated by JavaScript -->
                            <div class="text-center text-gray-500 py-4" id="noNotesMessage">
                                No notes yet. Add your first note!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mark Complete Button -->
                    {% if not progress.is_completed %}
                        <form method="POST" action="{% url 'mark_lesson_complete' course.slug lesson.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-check mr-2"></i>Mark as Complete
                            </button>
                        </form>
                    {% else %}
                        <div class="flex items-center text-green-600">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>Completed</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Navigation -->
                <div class="flex justify-between">
                    {% if prev_lesson %}
                        <a href="{% url 'lesson_detail' course.slug prev_lesson.id %}" class="btn-outline">
                            <i class="fas fa-arrow-left mr-2"></i>Previous Lesson
                        </a>
                    {% else %}
                        <div></div>
                    {% endif %}
                    
                    {% if next_lesson %}
                        <a href="{% url 'lesson_detail' course.slug next_lesson.id %}" class="btn-primary">
                            Next Lesson<i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    {% else %}
                        <a href="{% url 'course_detail' course.slug %}" class="btn-primary">
                            Back to Course
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar - Lesson List -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 sticky top-4">
                    <h3 class="font-bold mb-4 text-gray-900 dark:text-white">Course Content</h3>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        {% for l in lessons %}
                            <a href="{% url 'lesson_detail' course.slug l.id %}" 
                               class="block p-2 rounded {% if l.id == lesson.id %}bg-primary-100 dark:bg-primary-900{% else %}hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm {% if l.id == lesson.id %}text-primary-600 font-semibold{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                        {{ l.title }}
                                    </span>
                                    <i class="fas fa-check-circle text-green-500 text-xs"></i>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if lesson.video_url %}
        // Get video player elements
        const videoPlayer = document.getElementById('videoPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeBtn = document.getElementById('volumeBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const playbackRate = document.getElementById('playbackRate');
        const pipBtn = document.getElementById('pipBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const notesBtn = document.getElementById('notesBtn');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const notesSection = document.getElementById('notesSection');
        const noteText = document.getElementById('noteText');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const addTimestampBtn = document.getElementById('addTimestampBtn');
        const notesList = document.getElementById('notesList');
        const noNotesMessage = document.getElementById('noNotesMessage');
        
        // Video player functionality
        function updatePlayIcon() {
            if (videoPlayer.paused) {
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
            } else {
                playIcon.classList.remove('fa-play');
                playIcon.classList.add('fa-pause');
            }
        }
        
        function togglePlay() {
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
            updatePlayIcon();
        }
        
        function updateProgress() {
            const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
            progressBar.style.width = `${percent}%`;
            
            // Update time displays
            currentTimeEl.textContent = formatTime(videoPlayer.currentTime);
        }
        
        function setProgress(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = videoPlayer.duration;
            
            videoPlayer.currentTime = (clickX / width) * duration;
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        function updateDuration() {
            durationEl.textContent = formatTime(videoPlayer.duration);
        }
        
        function toggleMute() {
            videoPlayer.muted = !videoPlayer.muted;
            volumeBtn.innerHTML = videoPlayer.muted ? 
                '<i class="fas fa-volume-mute"></i>' : 
                '<i class="fas fa-volume-up"></i>';
        }
        
        function setVolume() {
            videoPlayer.volume = volumeSlider.value;
        }
        
        function setPlaybackRate() {
            videoPlayer.playbackRate = playbackRate.value;
        }
        
        function togglePictureInPicture() {
            if (videoPlayer.requestPictureInPicture) {
                videoPlayer.requestPictureInPicture();
            }
        }
        
        function toggleFullscreen() {
            if (videoPlayer.requestFullscreen) {
                videoPlayer.requestFullscreen();
            } else if (videoPlayer.webkitRequestFullscreen) {
                videoPlayer.webkitRequestFullscreen();
            } else if (videoPlayer.msRequestFullscreen) {
                videoPlayer.msRequestFullscreen();
            }
        }
        
        // Note functionality
        let notes = JSON.parse(localStorage.getItem(`lesson-notes-{{ lesson.id }}`)) || [];
        
        function displayNotes() {
            if (notes.length === 0) {
                noNotesMessage.style.display = 'block';
                notesList.innerHTML = '';
                return;
            }
            
            noNotesMessage.style.display = 'none';
            notesList.innerHTML = '';
            
            notes.forEach((note, index) => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-item';
                noteEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="note-timestamp" data-time="${note.time}">${formatTime(note.time)}</span>
                            <p class="mt-1">${note.text}</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteNote(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                notesList.appendChild(noteEl);
            });
            
            // Add event listeners to timestamps
            document.querySelectorAll('.note-timestamp').forEach(timestamp => {
                timestamp.addEventListener('click', function() {
                    const time = parseFloat(this.getAttribute('data-time'));
                    videoPlayer.currentTime = time;
                    videoPlayer.play();
                    updatePlayIcon();
                });
            });
        }
        
        function saveNote() {
            const text = noteText.value.trim();
            if (!text) return;
            
            notes.push({
                text: text,
                time: videoPlayer.currentTime,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem(`lesson-notes-{{ lesson.id }}`, JSON.stringify(notes));
            noteText.value = '';
            displayNotes();
        }
        
        function deleteNote(index) {
            notes.splice(index, 1);
            localStorage.setItem(`lesson-notes-{{ lesson.id }}`, JSON.stringify(notes));
            displayNotes();
        }
        
        function addTimestamp() {
            const currentTime = videoPlayer.currentTime;
            const timestampText = `[${formatTime(currentTime)}] `;
            noteText.value = timestampText + noteText.value;
            noteText.focus();
        }
        
        // Event listeners
        playPauseBtn.addEventListener('click', togglePlay);
        videoPlayer.addEventListener('click', togglePlay);
        videoPlayer.addEventListener('timeupdate', updateProgress);
        videoPlayer.addEventListener('loadedmetadata', updateDuration);
        videoPlayer.addEventListener('play', updatePlayIcon);
        videoPlayer.addEventListener('pause', updatePlayIcon);
        progressContainer.addEventListener('click', setProgress);
        volumeBtn.addEventListener('click', toggleMute);
        volumeSlider.addEventListener('input', setVolume);
        playbackRate.addEventListener('change', setPlaybackRate);
        pipBtn.addEventListener('click', togglePictureInPicture);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        notesBtn.addEventListener('click', () => {
            notesSection.classList.toggle('hidden');
        });
        addNoteBtn.addEventListener('click', () => {
            notesSection.classList.remove('hidden');
            noteText.focus();
        });
        saveNoteBtn.addEventListener('click', saveNote);
        addTimestampBtn.addEventListener('click', addTimestamp);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    videoPlayer.currentTime -= 5; // Rewind 5 seconds
                    break;
                case 'ArrowRight':
                    videoPlayer.currentTime += 5; // Forward 5 seconds
                    break;
                case 'ArrowUp':
                    videoPlayer.volume = Math.min(videoPlayer.volume + 0.1, 1);
                    volumeSlider.value = videoPlayer.volume;
                    break;
                case 'ArrowDown':
                    videoPlayer.volume = Math.max(videoPlayer.volume - 0.1, 0);
                    volumeSlider.value = videoPlayer.volume;
                    break;
                case 'KeyM':
                    toggleMute();
                    break;
                case 'KeyF':
                    toggleFullscreen();
                    break;
            }
        });
        
        // Initialize notes display
        displayNotes();
        {% endif %}
    });
    
    // Make deleteNote function available globally
    function deleteNote(index) {
        // This function is defined in the main script but needs to be global
        // The actual implementation is in the DOMContentLoaded event
        const notes = JSON.parse(localStorage.getItem(`lesson-notes-{{ lesson.id }}`)) || [];
        notes.splice(index, 1);
        localStorage.setItem(`lesson-notes-{{ lesson.id }}`, JSON.stringify(notes));
        
        // Re-display notes
        document.getElementById('notesList').innerHTML = '';
        if (notes.length === 0) {
            document.getElementById('noNotesMessage').style.display = 'block';
        } else {
            document.getElementById('noNotesMessage').style.display = 'none';
            notes.forEach((note, i) => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-item';
                noteEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="note-timestamp" data-time="${note.time}">${formatTime(note.time)}</span>
                            <p class="mt-1">${note.text}</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteNote(${i})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                document.getElementById('notesList').appendChild(noteEl);
            });
            
            // Add event listeners to timestamps
            document.querySelectorAll('.note-timestamp').forEach(timestamp => {
                timestamp.addEventListener('click', function() {
                    const videoPlayer = document.getElementById('videoPlayer');
                    const time = parseFloat(this.getAttribute('data-time'));
                    videoPlayer.currentTime = time;
                    videoPlayer.play();
                });
            });
        }
    }
    
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }
</script>
{% endblock %}
